<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
<title>Spring之LoadTimeWeaver&mdash;&mdash;一个需求引发的思考</title>
<body>
<!--StartFragment--><div class="blog_title">
    <div class="date"><span class="year">2011</span><span class="sep_year">-</span><span class="month">05</span><span class="sep_month">-</span><span class="day">27</span></div>
    <h3><a href="http://sexycoding.iteye.com/blog/1062372">Spring之LoadTimeWeaver――一个需求引发的思考</a></h3>
                <strong>文章分类:<a href="http://www.iteye.com/blogs/category/java" style="text-decoration:none;padding-right:10px;">Java编程</a></strong>    
  </div>

  <div class="blog_content">
    <p><span>最近有个需求――记录应用中某些接口被调用的轨迹，说白了，记录下入参、出参等即可。</span></p>
<p class="MsoNormal"><span lang="EN-US">&nbsp;</span></p>
<p class="MsoNormal"><span>我选用</span><span lang="EN-US">ApsectJ</span><span>解决这个问题，前期讨论说在接口层埋点，但这样有个问题，代码侵入比较严重，需要修改每个需要关注的接口实现类。经过一番讨论，决定使用</span><span lang="EN-US">AOP</span><span>拦截所有这样的接口。</span></p>
<p class="MsoNormal"><span lang="EN-US">&nbsp;</span></p>
<p class="MsoNormal"><span>后面又有个新的要求――沙箱环境拦截，生产环境不予拦截。</span></p>
<p class="MsoNormal"><span lang="EN-US">&nbsp;</span></p>
<p class="MsoNormal"><span>这样就有个眼前的问题需要我们解决，就是同一份应用包如何区分沙箱环境和生产环境并执行不同的行为。同事提醒我可以考虑</span><span lang="EN-US">Spring</span><span>的</span><span lang="EN-US">LTW</span><span>，即</span><span lang="EN-US">Load Time
Weaving</span><span>。</span></p>
<p class="MsoNormal"><span lang="EN-US">&nbsp;</span></p>
<p class="MsoNormal"><span lang="EN-US">在</span><span lang="EN-US">Java </span><span lang="EN-US">语言中，从织入切面的方式上来看，存在三种织入方式：编译期织入、类加载期织入和运行期织入。编译期织入是指在</span><span lang="EN-US">Java</span><span lang="EN-US">编译期，采用特殊的编译器，将切面织入到</span><span lang="EN-US">Java</span><span lang="EN-US">类中；而类加载期织入则指通过特殊的类加载器，在类字节码加载到</span><span lang="EN-US">JVM</span><span lang="EN-US">时，织入切面；运行期织入则是采用</span><span lang="EN-US">CGLib</span><span lang="EN-US">工具或</span><span lang="EN-US">JDK</span><span lang="EN-US">动态代理进行切面的织入。</span><span lang="EN-US">&nbsp;</span></p>
<p class="MsoNormal"><span lang="EN-US"><br>AspectJ</span><span>采用编译期织入和类加载期织入的方式织入切面，是语言级的</span><span lang="EN-US">AOP</span><span>实现，提供了完备的</span><span lang="EN-US">AOP</span><span>支持。</span><span lang="EN-US">它用</span><span lang="EN-US">AspectJ</span><span lang="EN-US">语言定义切面，在编译期或类加载期将切面织入到</span><span lang="EN-US">Java</span><span lang="EN-US">类中。</span><span lang="EN-US">&nbsp;</span></p>
<p class="MsoNormal"><span lang="EN-US">&nbsp;</span></p>
<p class="MsoNormal"><span lang="EN-US">AspectJ</span><span>提供了两种切面织入方式，第一种通过特殊编译器，在编译期，将</span><span lang="EN-US">AspectJ</span><span>语言编写的切面类织入到</span><span lang="EN-US">Java</span><span>类中，可以通过一个</span><span lang="EN-US">Ant</span><span>或</span><span lang="EN-US">Maven</span><span>任务来完成这个操作；第二种方式是类加载期织入，也简称为</span><span lang="EN-US">LTW</span><span>（</span><span lang="EN-US">Load Time Weaving</span><span>）。</span><span lang="EN-US">&nbsp;</span></p>
<p class="MsoNormal"><span lang="EN-US">&nbsp;</span></p>
<p class="MsoNormal"><span>如何使用</span><span lang="EN-US">Load Time Weaving</span><span>？首先，需要通过</span><span lang="EN-US">JVM</span><span>的</span><span lang="EN-US">-javaagent</span><span>参数设置</span><span lang="EN-US">LTW</span><span>的织入器类包，以代理</span><span lang="EN-US">JVM</span><span>默认的类加载器；第二，</span><span lang="EN-US">LTW</span><span>织入器需要一个</span><span lang="EN-US">
aop.xml</span><span>文件，在该文件中指定切面类和需要进行切面织入的目标类。</span><span lang="EN-US">&nbsp;</span></p>
<p class="MsoNormal"><span lang="EN-US">&nbsp;</span></p>
<p class="MsoNormal"><span>下面我将通过一个简单的例子在描述如何使用</span><span lang="EN-US">LTW</span><span>。</span></p>
<p class="MsoNormal"><span lang="EN-US">&nbsp;</span></p>
<p class="MsoNormal"><span>例子所作的是记录被调用方法的执行时间和</span><span lang="EN-US">CPU</span><span>使用率。其实这在实际生产中很有用，与其拉一堆性能测试工具，不如动手做个简单的分析切面，使我们能很快得到一些性能指标。我指的是没有硬性的性能测试需求下。</span></p>
<p class="MsoNormal"><span lang="EN-US">&nbsp;</span></p>
<p class="MsoNormal"><span>首先我们编写一个被织入的受体类，也就是被拦截的对象。</span></p>
<p class="MsoNormal" style="text-indent: 0cm;">&nbsp;</p>
<p class="MsoNormal" style="text-indent: 0cm;">&nbsp;</p>
<div id="" class="dp-highlighter"><div class="bar"><div class="tools">Java代码 <embed src="clipboard_new.swf" flashvars="clipboard=public%20class%20DemoBean%20%7B%0A%20%20%20%20public%20void%20run()%20%7B%0A%20%20%20%20%20%20%20System.out.println(%22Run%22)%3B%0A%20%20%20%20%7D%0A%7D" quality="high" allowscriptaccess="always" type="application/x-shockwave-flash" pluginspage="http://www.macromedia.com/go/getflashplayer" width="14" height="15"></embed>&nbsp;<a href="javascript:void()" title="收藏这段代码" onClick="code_favorites_do_favorite(this);return false;"><img class="star" src="icon_star.png" alt="收藏代码"></a></div></div><ol class="dp-j" start="1"><li><span><span class="keyword">public</span><span>&nbsp;</span><span class="keyword">class</span><span>&nbsp;DemoBean&nbsp;{&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">public</span><span>&nbsp;</span><span class="keyword">void</span><span>&nbsp;run()&nbsp;{&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;System.out.println(<span class="string">"Run"</span><span>);&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;&nbsp;</span></li><li><span>}&nbsp;&nbsp;</span></li></ol></div>
&nbsp;&nbsp;&nbsp;
<p class="MsoNormal" style="text-indent: 0cm;"><span>接着，我们编写分析方法执行效率的切面。</span></p>
<p class="MsoNormal" style="text-indent: 0cm;">&nbsp;</p>
<div id="" class="dp-highlighter"><div class="bar"><div class="tools">Java代码 <div role="button" tabindex="0" srcattribute="about:blank" title="about:blank" style="background: url(&quot;chrome://flashblock/content/flash.png&quot;) no-repeat scroll center center transparent ! important; min-width: 32px ! important; min-height: 32px ! important; width: 32px; height: 32px; border: 1px solid rgb(223, 223, 223); cursor: pointer; overflow: hidden; display: inline-block; visibility: visible ! important; -moz-box-sizing: border-box;" bgactive="url(chrome://flashblock/content/flashplay.png) no-repeat center" bginactive="url(chrome://flashblock/content/flash.png) no-repeat center"></div>&nbsp;<a href="javascript:void()" title="收藏这段代码" onClick="code_favorites_do_favorite(this);return false;"><img class="star" src="icon_star.png" alt="收藏代码"></a></div></div><ol class="dp-j" start="1"><li><span><span>&lt;span&nbsp;style=</span><span class="string">"font-family:&nbsp;'Courier&nbsp;New';&nbsp;color:&nbsp;#646464;&nbsp;font-size:&nbsp;x-small;"</span><span>&gt;</span><span class="annotation">@Aspect</span><span>&nbsp;&nbsp;</span></span></li><li><span><span class="keyword">public</span><span>&nbsp;</span><span class="keyword">class</span><span>&nbsp;ProfilingAspect&nbsp;{&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="annotation">@Around</span><span>(</span><span class="string">"profileMethod()"</span><span>)&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">public</span><span>&nbsp;Object&nbsp;profile(ProceedingJoinPoint&nbsp;pjp)&nbsp;</span><span class="keyword">throws</span><span>&nbsp;Throwable&nbsp;{&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;StopWatch&nbsp;sw&nbsp;=&nbsp;<span class="keyword">new</span><span>&nbsp;StopWatch(getClass().getSimpleName());&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">try</span><span>&nbsp;{&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sw.start(pjp.getSignature().getName());&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">return</span><span>&nbsp;pjp.proceed();&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;<span class="keyword">finally</span><span>&nbsp;{&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sw.stop();&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;System.out.println(sw.prettyPrint());&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="annotation">@Pointcut</span><span>(</span><span class="string">"execution(public&nbsp;*&nbsp;com.shansun..*(..))"</span><span>)&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">public</span><span>&nbsp;</span><span class="keyword">void</span><span>&nbsp;profileMethod()&nbsp;{}&nbsp;&nbsp;</span></span></li><li><span>}&lt;/span&gt;&nbsp;&nbsp;</span></li></ol></div>
<p><span style="font-family: 'Courier New'; color: #646464; font-size: x-small;">&nbsp;</span></p>
<p class="MsoNormal"><span lang="EN-US"><span> </span></span><span>前文提到，我们还需要一个</span><span lang="EN-US">aop.xml</span><span>。这个文件要求放在</span><span lang="EN-US">META-INF/aop.xml</span><span>路径下，以告知</span><span lang="EN-US">AspectJ
Weaver</span><span>我们需要把</span><span lang="EN-US">ProfilingAspect</span><span>织入到应用的哪些类中。</span></p>
<p class="MsoNormal" style="text-indent: 0cm;">&nbsp;</p>
<div id="" class="dp-highlighter"><div class="bar"><div class="tools">Xml代码 <div role="button" tabindex="0" srcattribute="about:blank" title="about:blank" style="background: url(&quot;chrome://flashblock/content/flash.png&quot;) no-repeat scroll center center transparent ! important; min-width: 32px ! important; min-height: 32px ! important; width: 32px; height: 32px; border: 1px solid rgb(223, 223, 223); cursor: pointer; overflow: hidden; display: inline-block; visibility: visible ! important; -moz-box-sizing: border-box;" bgactive="url(chrome://flashblock/content/flashplay.png) no-repeat center" bginactive="url(chrome://flashblock/content/flash.png) no-repeat center"></div>&nbsp;<a href="javascript:void()" title="收藏这段代码" onClick="code_favorites_do_favorite(this);return false;"><img class="star" src="icon_star.png" alt="收藏代码"></a></div></div><ol class="dp-xml" start="1"><li><span><span class="tag">&lt;</span><span class="tag-name">span</span><span>&nbsp;</span><span class="attribute">style</span><span>=</span><span class="attribute-value">"font-family:&nbsp;'Courier&nbsp;New';&nbsp;color:&nbsp;#008080;&nbsp;font-size:&nbsp;x-small;"</span><span class="tag">&gt;</span><span>&lt;!DOCTYPE&nbsp;aspectj&nbsp;PUBLIC&nbsp;"-//AspectJ//DTD//EN"&nbsp;"http://www.eclipse.org/aspectj/dtd/aspectj.dtd"</span><span class="tag">&gt;</span><span>&nbsp;&nbsp;</span></span></li><li><span><span class="tag">&lt;</span><span class="tag-name">aspectj</span><span class="tag">&gt;</span><span>&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="tag">&lt;</span><span class="tag-name">weaver</span><span class="tag">&gt;</span><span>&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tag">&lt;</span><span class="tag-name">include</span><span>&nbsp;</span><span class="attribute">within</span><span>=</span><span class="attribute-value">"com.shansun..*"</span><span>&nbsp;</span><span class="tag">/&gt;</span><span>&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="tag">&lt;/</span><span class="tag-name">weaver</span><span class="tag">&gt;</span><span>&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="tag">&lt;</span><span class="tag-name">aspects</span><span class="tag">&gt;</span><span>&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comments">&lt;!--&nbsp;weave&nbsp;in&nbsp;just&nbsp;this&nbsp;aspect&nbsp;--&gt;</span><span>&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tag">&lt;</span><span class="tag-name">aspect</span><span>&nbsp;</span><span class="attribute">name</span><span>=</span><span class="attribute-value">"com.shansun.multidemo.spring.ltw.ProfilingAspect"</span><span>&nbsp;</span><span class="tag">/&gt;</span><span>&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="tag">&lt;/</span><span class="tag-name">aspects</span><span class="tag">&gt;</span><span>&nbsp;&nbsp;</span></span></li><li><span><span class="tag">&lt;/</span><span class="tag-name">aspectj</span><span class="tag">&gt;</span><span class="tag">&lt;/</span><span class="tag-name">span</span><span class="tag">&gt;</span><span>&nbsp;&nbsp;</span></span></li></ol></div>
<p><span style="font-family: 'Courier New'; color: #008080; font-size: x-small;">&nbsp;</span></p>
<p class="MsoNormal"><span lang="EN-US"><span> </span></span><span>目前为止，本次切面的“攻”和“受”都准备好了，我们还需要一个中间媒介――</span><span lang="EN-US">LoadTimeWeaver</span><span>。我们将</span><span lang="EN-US">Spring</span><span>的配置文件添加红色标识内容。</span></p>
<p class="MsoNormal" style="text-indent: 0cm;">&nbsp;</p>
<div id="" class="dp-highlighter"><div class="bar"><div class="tools">Xml代码 <div role="button" tabindex="0" srcattribute="about:blank" title="about:blank" style="background: url(&quot;chrome://flashblock/content/flash.png&quot;) no-repeat scroll center center transparent ! important; min-width: 32px ! important; min-height: 32px ! important; width: 32px; height: 32px; border: 1px solid rgb(223, 223, 223); cursor: pointer; overflow: hidden; display: inline-block; visibility: visible ! important; -moz-box-sizing: border-box;" bgactive="url(chrome://flashblock/content/flashplay.png) no-repeat center" bginactive="url(chrome://flashblock/content/flash.png) no-repeat center"></div>&nbsp;<a href="javascript:void()" title="收藏这段代码" onClick="code_favorites_do_favorite(this);return false;"><img class="star" src="icon_star.png" alt="收藏代码"></a></div></div><ol class="dp-xml" start="1"><li><span><span class="tag">&lt;?</span><span class="tag-name">xml</span><span>&nbsp;</span><span class="attribute">version</span><span>=</span><span class="attribute-value">"1.0"</span><span>&nbsp;</span><span class="attribute">encoding</span><span>=</span><span class="attribute-value">"GBK"</span><span class="tag">?&gt;</span><span>&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;</span></li><li><span><span class="tag">&lt;</span><span class="tag-name">beans</span><span>&nbsp;</span><span class="attribute">xmlns</span><span>=</span><span class="attribute-value">"http://www.springframework.org/schema/beans"</span><span>&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="attribute">xmlns:xsi</span><span>=</span><span class="attribute-value">"http://www.w3.org/2001/XMLSchema-instance"</span><span>&nbsp;</span><span class="attribute">xmlns:aop</span><span>=</span><span class="attribute-value">"http://www.springframework.org/schema/aop"</span><span>&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="attribute">xmlns:context</span><span>=</span><span class="attribute-value">"http://www.springframework.org/schema/context"</span><span>&nbsp;</span><span class="attribute">xmlns:tx</span><span>=</span><span class="attribute-value">"http://www.springframework.org/schema/tx"</span><span>&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="attribute">xsi:schemaLocation</span><span>="&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;http://www.springframework.org/schema/beans&nbsp;http://www.springframework.org/schema/beans/spring-beans-2.5.xsd&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;http://www.springframework.org/schema/aop&nbsp;http://www.springframework.org/schema/aop/spring-aop-2.5.xsd&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;http://www.springframework.org/schema/context&nbsp;http://www.springframework.org/schema/context/spring-context-2.5.xsd&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;http://www.springframework.org/schema/tx&nbsp;http://www.springframework.org/schema/tx/spring-tx-2.5.xsd"<span class="tag">&gt;</span><span>&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="tag">&lt;</span><span class="tag-name">context:load-time-weaver</span><span>&nbsp;</span><span class="attribute">aspectj-weaving</span><span>=</span><span class="attribute-value">"autodetect"</span><span>&nbsp;</span><span class="tag">/&gt;</span><span>&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="tag">&lt;</span><span class="tag-name">context:component-scan</span><span>&nbsp;</span><span class="attribute">base-package</span><span>=</span><span class="attribute-value">"com.shansun.multidemo"</span><span class="tag">&gt;</span><span class="tag">&lt;/</span><span class="tag-name">context:component-scan</span><span class="tag">&gt;</span><span>&nbsp;&nbsp;</span></span></li><li><span><span class="tag">&lt;/</span><span class="tag-name">beans</span><span class="tag">&gt;</span><span>&nbsp;&nbsp;</span></span></li></ol></div>
<p>&nbsp;</p>
<p class="MsoNormal" style="text-indent: 0cm;"><span>通过</span><span lang="EN-US"> &lt;context:load-time-weaver <span>&nbsp;</span>aspectj-weaving="on" /&gt; </span><span>使</span><span lang="EN-US"> spring </span><span>开启</span><span lang="EN-US">
loadtimeweaver, </span><span>注意</span><span lang="EN-US"> aspectj-weaving </span><span>有三个选项</span><span lang="EN-US"> : on,
off, auto-detect,&nbsp;</span><span>如果设置为</span><span lang="EN-US"> auto-detect, spring </span><span>将会在</span><span lang="EN-US"> classpath
</span><span>中查找</span><span lang="EN-US"> aspejct </span><span>需要的</span><span lang="EN-US"> META-INF/aop.xml</span><span>，</span><span> </span><span>如果找到则开启</span><span lang="EN-US">
aspectj weaving, </span><span>这个逻辑在</span><span lang="EN-US">
LoadTimeWeaverBeanDefinitionParser#isAspectJWeavingEnabled </span><span>方法中：</span></p>
<p class="MsoNormal" style="text-indent: 0cm;"><span style="font-family: 'Courier New'; color: #7f0055; font-size: x-small;"><strong></strong></span></p>
<div id="" class="dp-highlighter"><div class="bar"><div class="tools">Java代码 <div role="button" tabindex="0" srcattribute="about:blank" title="about:blank" style="background: url(&quot;chrome://flashblock/content/flash.png&quot;) no-repeat scroll center center transparent ! important; min-width: 32px ! important; min-height: 32px ! important; width: 32px; height: 32px; border: 1px solid rgb(223, 223, 223); cursor: pointer; overflow: hidden; display: inline-block; visibility: visible ! important; -moz-box-sizing: border-box;" bgactive="url(chrome://flashblock/content/flashplay.png) no-repeat center" bginactive="url(chrome://flashblock/content/flash.png) no-repeat center"></div>&nbsp;<a href="javascript:void()" title="收藏这段代码" onClick="code_favorites_do_favorite(this);return false;"><img class="star" src="icon_star.png" alt="收藏代码"></a></div></div><ol class="dp-j" start="1"><li><span><span>&lt;span&nbsp;style=</span><span class="string">"font-family:&nbsp;'Courier&nbsp;New';&nbsp;color:&nbsp;#7f0055;&nbsp;font-size:&nbsp;x-small;"</span><span>&gt;&lt;strong&gt;</span><span class="keyword">protected</span><span>&nbsp;</span><span class="keyword">boolean</span><span>&nbsp;isAspectJWeavingEnabled(String&nbsp;value,&nbsp;ParserContext&nbsp;parserContext)&nbsp;{&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span><span>&nbsp;(</span><span class="string">"on"</span><span>.equals(value))&nbsp;{&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">return</span><span>&nbsp;</span><span class="keyword">true</span><span>;&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">else</span><span>&nbsp;</span><span class="keyword">if</span><span>&nbsp;(</span><span class="string">"off"</span><span>.equals(value))&nbsp;{&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">return</span><span>&nbsp;</span><span class="keyword">false</span><span>;&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">else</span><span>&nbsp;{&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">//&nbsp;Determine&nbsp;default...</span><span>&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ClassLoader&nbsp;cl&nbsp;=&nbsp;parserContext.getReaderContext().getResourceLoader().getClassLoader();&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">return</span><span>&nbsp;(cl.getResource(ASPECTJ_AOP_XML_RESOURCE)&nbsp;!=&nbsp;</span><span class="keyword">null</span><span>);&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;&nbsp;</span></li><li><span>}&lt;/strong&gt;&lt;/span&gt;&nbsp;&nbsp;</span></li></ol></div>
<p><span style="font-family: 'Courier New'; color: #7f0055; font-size: x-small;"><strong>&nbsp;</strong></span></p>
<p class="MsoNormal"><span>一切都准备就绪――切面类、</span><span lang="EN-US">aop.xml</span><span>、</span><span lang="EN-US">Spring</span><span>的配置，我们就创建一个</span><span lang="EN-US">main</span><span>方法来掩饰</span><span lang="EN-US">LTW</span><span>的功效吧。</span></p>
<p class="MsoNormal" style="text-indent: 0cm;">&nbsp;</p>
<div id="" class="dp-highlighter"><div class="bar"><div class="tools">Java代码 <div role="button" tabindex="0" srcattribute="about:blank" title="about:blank" style="background: url(&quot;chrome://flashblock/content/flash.png&quot;) no-repeat scroll center center transparent ! important; min-width: 32px ! important; min-height: 32px ! important; width: 32px; height: 32px; border: 1px solid rgb(223, 223, 223); cursor: pointer; overflow: hidden; display: inline-block; visibility: visible ! important; -moz-box-sizing: border-box;" bgactive="url(chrome://flashblock/content/flashplay.png) no-repeat center" bginactive="url(chrome://flashblock/content/flash.png) no-repeat center"></div>&nbsp;<a href="javascript:void()" title="收藏这段代码" onClick="code_favorites_do_favorite(this);return false;"><img class="star" src="icon_star.png" alt="收藏代码"></a></div></div><ol class="dp-j" start="1"><li><span><span class="keyword">public</span><span>&nbsp;</span><span class="keyword">class</span><span>&nbsp;Main&nbsp;{&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">public</span><span>&nbsp;</span><span class="keyword">static</span><span>&nbsp;</span><span class="keyword">void</span><span>&nbsp;main(String[]&nbsp;args)&nbsp;{&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ApplicationContext&nbsp;ctx&nbsp;=&nbsp;<span class="keyword">new</span><span>&nbsp;ClassPathXmlApplicationContext(</span><span class="string">"applicationContext.xml"</span><span>);&nbsp;&nbsp;</span></span></li><li><span><span class="comment">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;DemoBean&nbsp;bean&nbsp;=&nbsp;(DemoBean)&nbsp;ctx.getBean("demoBean");</span><span>&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;DemoBean&nbsp;bean&nbsp;=&nbsp;<span class="keyword">new</span><span>&nbsp;DemoBean();&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;bean.run();&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;&nbsp;</span></li><li><span>}&nbsp;&nbsp;</span></li></ol></div>
<p>&nbsp;<span style="font-family: 'Courier New'; font-size: 13px;">&nbsp;</span></p>
<p>&nbsp;</p>
<p class="MsoNormal"><span style="font-size: 10.0pt;" lang="EN-US"><span> </span></span><span>因为这个</span><span lang="EN-US">LTW</span><span>使用成熟的</span><span lang="EN-US">AspectJ</span><span>，我们并不局限于通知</span><span lang="EN-US">Spring
beans</span><span>的方法</span><span lang="EN-US">。所以上述代码中从</span><span lang="EN-US">ApplicationContext</span><span lang="EN-US">中获取</span><span lang="EN-US">Bean</span><span lang="EN-US">和直接实例化一个</span><span lang="EN-US">Bean</span><span lang="EN-US">的效果是一样的。</span></p>
<p class="MsoNormal" style="text-indent: 0cm;"><span lang="EN-US"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></span></p>
<p class="MsoNormal"><span lang="EN-US"><span> </span></span><span>注意，这里以使用</span><span lang="EN-US">Eclipse</span><span>演示上述代码为例，需要在运行参数中稍作设置，即添加前文提到的</span><span lang="EN-US">-javaagent</span><span>，来取代默认的类加载器。</span></p>
<p class="MsoNormal"><span lang="EN-US"><img src="83b9b499-dc72-34f7-8053-b2f0a8a3e10a.png" alt="" width="554" height="515"></span></p>
<p class="MsoNormal" style="text-indent: 0cm;">&nbsp;</p>
<p class="MsoNormal" style="text-indent: 0cm;"><span>输出结果如下：</span></p>
<p class="MsoNormal" style="margin-left: 22.0pt; text-indent: 0cm;"><em><span style="font-size: 10.0pt;" lang="EN-US">Run</span></em><em></em></p>
<p class="MsoNormal" style="margin-left: 22.0pt; text-indent: 0cm;"><em><span style="font-size: 10.0pt;" lang="EN-US">StopWatch
'ProfilingAspect': running time (millis) = 0</span></em><em></em></p>
<p class="MsoNormal" style="margin-left: 22.0pt; text-indent: 0cm;"><em><span style="font-size: 10.0pt;" lang="EN-US">-----------------------------------------</span></em><em></em></p>
<p class="MsoNormal" style="margin-left: 22.0pt; text-indent: 0cm;"><em><span style="font-size: 10.0pt;" lang="EN-US">ms<span>&nbsp;&nbsp;&nbsp;&nbsp; </span>%<span>&nbsp;&nbsp;&nbsp;&nbsp;
</span>Task name</span></em><em></em></p>
<p class="MsoNormal" style="margin-left: 22.0pt; text-indent: 0cm;"><em><span style="font-size: 10.0pt;" lang="EN-US">-----------------------------------------</span></em><em></em></p>
<p class="MsoListParagraph"><span style="font-size: 10.0pt;" lang="EN-US">&nbsp;&nbsp; &nbsp; &nbsp;00<span style="font-size: x-small;"><em>01</em></span><span style="font: 7.0pt ;">&nbsp;</span></span><em><span style="font-size: 10.0pt;" lang="EN-US">100%</span></em><em><span style="font-size: 10.0pt;" lang="EN-US"><span>&nbsp; </span>run</span></em><em></em></p>
<p class="MsoNormal"><em><span lang="EN-US">&nbsp;</span></em></p>
<p class="MsoNormal"><span>至此，</span><span lang="EN-US">LTW</span><span>可以正常使用了，但是麻烦的是我需要在</span><span lang="EN-US">VM</span><span>参数里加上</span><span lang="EN-US">-javaagent</span><span>这么个东东，如果不加会如何呢？试试看。</span></p>
<p class="MsoNormal" style="text-indent: 0cm;">&nbsp;</p>
<div id="" class="dp-highlighter"><div class="bar"><div class="tools">Java代码 <div role="button" tabindex="0" srcattribute="about:blank" title="about:blank" style="background: url(&quot;chrome://flashblock/content/flash.png&quot;) no-repeat scroll center center transparent ! important; min-width: 32px ! important; min-height: 32px ! important; width: 32px; height: 32px; border: 1px solid rgb(223, 223, 223); cursor: pointer; overflow: hidden; display: inline-block; visibility: visible ! important; -moz-box-sizing: border-box;" bgactive="url(chrome://flashblock/content/flashplay.png) no-repeat center" bginactive="url(chrome://flashblock/content/flash.png) no-repeat center"></div>&nbsp;<a href="javascript:void()" title="收藏这段代码" onClick="code_favorites_do_favorite(this);return false;"><img class="star" src="icon_star.png" alt="收藏代码"></a></div></div><ol class="dp-j" start="1"><li><span><span>&lt;span&nbsp;style=</span><span class="string">"font-family:&nbsp;'Courier&nbsp;New';&nbsp;color:&nbsp;#ff0000;&nbsp;font-size:&nbsp;x-small;"</span><span>&gt;Exception&nbsp;in&nbsp;thread&nbsp;</span><span class="string">"main"</span><span>&nbsp;java.lang.IllegalStateException:&nbsp;Must&nbsp;start&nbsp;with&nbsp;Java&nbsp;agent&nbsp;to&nbsp;use&nbsp;InstrumentationLoadTimeWeaver.&nbsp;See&nbsp;Spring&nbsp;documentation.&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;at&nbsp;org.springframework.instrument.classloading.InstrumentationLoadTimeWeaver.addTransformer(InstrumentationLoadTimeWeaver.java:<span class="number">88</span><span>)&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;at&nbsp;org.springframework.context.weaving.AspectJWeavingEnabler.postProcessBeanFactory(AspectJWeavingEnabler.java:<span class="number">69</span><span>)&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;at&nbsp;org.springframework.context.support.AbstractApplicationContext.invokeBeanFactoryPostProcessors(AbstractApplicationContext.java:<span class="number">553</span><span>)&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;at&nbsp;org.springframework.context.support.AbstractApplicationContext.invokeBeanFactoryPostProcessors(AbstractApplicationContext.java:<span class="number">536</span><span>)&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;at&nbsp;org.springframework.context.support.AbstractApplicationContext.refresh(AbstractApplicationContext.java:<span class="number">362</span><span>)&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;at&nbsp;org.springframework.context.support.ClassPathXmlApplicationContext.&lt;init&gt;(ClassPathXmlApplicationContext.java:<span class="number">139</span><span>)&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;at&nbsp;org.springframework.context.support.ClassPathXmlApplicationContext.&lt;init&gt;(ClassPathXmlApplicationContext.java:<span class="number">83</span><span>)&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;at&nbsp;com.shansun.multidemo.spring.Main.main(Main.java:<span class="number">25</span><span>)&lt;/span&gt;&nbsp;&nbsp;</span></span></li></ol></div>
<p class="MsoNormal"><span>必需使用</span><span lang="EN-US">java agent</span><span>么？仔细观察异常的出处</span><span style="font-size: 10.0pt;" lang="EN-US">InstrumentationLoadTimeWeaver</span><span lang="EN-US">。</span><span>再深入这个类的内容，发现异常是由下述方法抛出的。</span></p>
<p class="MsoNormal" style="text-indent: 0cm;">&nbsp;</p>
<div id="" class="dp-highlighter"><div class="bar"><div class="tools">Java代码 <div role="button" tabindex="0" srcattribute="about:blank" title="about:blank" style="background: url(&quot;chrome://flashblock/content/flash.png&quot;) no-repeat scroll center center transparent ! important; min-width: 32px ! important; min-height: 32px ! important; width: 32px; height: 32px; border: 1px solid rgb(223, 223, 223); cursor: pointer; overflow: hidden; display: inline-block; visibility: visible ! important; -moz-box-sizing: border-box;" bgactive="url(chrome://flashblock/content/flashplay.png) no-repeat center" bginactive="url(chrome://flashblock/content/flash.png) no-repeat center"></div>&nbsp;<a href="javascript:void()" title="收藏这段代码" onClick="code_favorites_do_favorite(this);return false;"><img class="star" src="icon_star.png" alt="收藏代码"></a></div></div><ol class="dp-j" start="1"><li><span><span class="keyword">public</span><span>&nbsp;</span><span class="keyword">void</span><span>&nbsp;addTransformer(ClassFileTransformer&nbsp;transformer)&nbsp;{&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Assert.notNull(transformer,&nbsp;<span class="string">"Transformer&nbsp;must&nbsp;not&nbsp;be&nbsp;null"</span><span>);&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;FilteringClassFileTransformer&nbsp;actualTransformer&nbsp;=&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">new</span><span>&nbsp;FilteringClassFileTransformer(transformer,&nbsp;</span><span class="keyword">this</span><span>.classLoader);&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">synchronized</span><span>&nbsp;(</span><span class="keyword">this</span><span>.transformers)&nbsp;{&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span><span>&nbsp;(</span><span class="keyword">this</span><span>.instrumentation&nbsp;==&nbsp;</span><span class="keyword">null</span><span>)&nbsp;{&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">throw</span><span>&nbsp;</span><span class="keyword">new</span><span>&nbsp;IllegalStateException(&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"Must&nbsp;start&nbsp;with&nbsp;Java&nbsp;agent&nbsp;to&nbsp;use&nbsp;InstrumentationLoadTimeWeaver.&nbsp;See&nbsp;Spring&nbsp;documentation."</span><span>);&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">this</span><span>.instrumentation.addTransformer(actualTransformer);&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">this</span><span>.transformers.add(actualTransformer);&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;&nbsp;</span></li><li><span>}&nbsp;&nbsp;</span></li></ol></div>
<p>&nbsp;</p>
<p class="MsoNormal"><span>不难发现它在校验</span><span lang="EN-US">instrumentation</span><span>是否为空的时候抛出的异常。有办法啦，重写</span><span lang="EN-US">InstrumentationLoadTimeWeaver</span><span>的</span><span lang="EN-US">addTransformer</span><span>方法，隐匿异常即可。</span></p>
<p class="MsoNormal" style="text-indent: 0cm;">&nbsp;</p>
<p class="MsoNormal" style="text-indent: 0cm;">&nbsp;</p>
<div id="" class="dp-highlighter"><div class="bar"><div class="tools">Java代码 <div role="button" tabindex="0" srcattribute="about:blank" title="about:blank" style="background: url(&quot;chrome://flashblock/content/flash.png&quot;) no-repeat scroll center center transparent ! important; min-width: 32px ! important; min-height: 32px ! important; width: 32px; height: 32px; border: 1px solid rgb(223, 223, 223); cursor: pointer; overflow: hidden; display: inline-block; visibility: visible ! important; -moz-box-sizing: border-box;" bgactive="url(chrome://flashblock/content/flashplay.png) no-repeat center" bginactive="url(chrome://flashblock/content/flash.png) no-repeat center"></div>&nbsp;<a href="javascript:void()" title="收藏这段代码" onClick="code_favorites_do_favorite(this);return false;"><img class="star" src="icon_star.png" alt="收藏代码"></a></div></div><ol class="dp-j" start="1"><li><span><span class="keyword">public</span><span>&nbsp;</span><span class="keyword">class</span><span>&nbsp;ExtInstrumentationLoadTimeWeaver&nbsp;</span><span class="keyword">extends</span><span>&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;InstrumentationLoadTimeWeaver&nbsp;{&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="annotation">@Override</span><span>&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">public</span><span>&nbsp;</span><span class="keyword">void</span><span>&nbsp;addTransformer(ClassFileTransformer&nbsp;transformer)&nbsp;{&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">try</span><span>&nbsp;{&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">super</span><span>.addTransformer(transformer);&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;<span class="keyword">catch</span><span>&nbsp;(Exception&nbsp;e)&nbsp;{}&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;&nbsp;</span></li><li><span>}&nbsp;&nbsp;</span></li></ol></div>
&nbsp;
<p class="MsoNormal" style="text-indent: 0cm;"><span style="font-size: 10.0pt;" lang="EN-US"><span>&nbsp;&nbsp;&nbsp; </span></span></p>
<p class="MsoNormal"><span style="font-size: 10.0pt;" lang="EN-US"><span> </span></span><span>这时，我们还需要做一件事，将</span><span lang="EN-US">Spring</span><span>配置文件中的</span><span lang="EN-US">load-time-weaver</span><span>入口设置为我们刚自定义的</span><span lang="EN-US">ExtInstrumentationLoadTimeWeaver</span><span>即可。</span></p>
<p class="MsoNormal" style="text-indent: 0cm;">&nbsp;</p>
<p class="MsoNormal" style="text-indent: 0cm;">&nbsp;</p>
<div id="" class="dp-highlighter"><div class="bar"><div class="tools">Xml代码 <div role="button" tabindex="0" srcattribute="about:blank" title="about:blank" style="background: url(&quot;chrome://flashblock/content/flash.png&quot;) no-repeat scroll center center transparent ! important; min-width: 32px ! important; min-height: 32px ! important; width: 32px; height: 32px; border: 1px solid rgb(223, 223, 223); cursor: pointer; overflow: hidden; display: inline-block; visibility: visible ! important; -moz-box-sizing: border-box;" bgactive="url(chrome://flashblock/content/flashplay.png) no-repeat center" bginactive="url(chrome://flashblock/content/flash.png) no-repeat center"></div>&nbsp;<a href="javascript:void()" title="收藏这段代码" onClick="code_favorites_do_favorite(this);return false;"><img class="star" src="icon_star.png" alt="收藏代码"></a></div></div><ol class="dp-xml" start="1"><li><span><span class="tag">&lt;?</span><span class="tag-name">xml</span><span>&nbsp;</span><span class="attribute">version</span><span>=</span><span class="attribute-value">"1.0"</span><span>&nbsp;</span><span class="attribute">encoding</span><span>=</span><span class="attribute-value">"GBK"</span><span class="tag">?&gt;</span><span>&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;</span></li><li><span><span class="tag">&lt;</span><span class="tag-name">beans</span><span>&nbsp;</span><span class="attribute">xmlns</span><span>=</span><span class="attribute-value">"http://www.springframework.org/schema/beans"</span><span>&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="attribute">xmlns:xsi</span><span>=</span><span class="attribute-value">"http://www.w3.org/2001/XMLSchema-instance"</span><span>&nbsp;</span><span class="attribute">xmlns:aop</span><span>=</span><span class="attribute-value">"http://www.springframework.org/schema/aop"</span><span>&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="attribute">xmlns:context</span><span>=</span><span class="attribute-value">"http://www.springframework.org/schema/context"</span><span>&nbsp;</span><span class="attribute">xmlns:tx</span><span>=</span><span class="attribute-value">"http://www.springframework.org/schema/tx"</span><span>&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="attribute">xsi:schemaLocation</span><span>="&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;http://www.springframework.org/schema/beans&nbsp;http://www.springframework.org/schema/beans/spring-beans-2.5.xsd&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;http://www.springframework.org/schema/aop&nbsp;http://www.springframework.org/schema/aop/spring-aop-2.5.xsd&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;http://www.springframework.org/schema/context&nbsp;http://www.springframework.org/schema/context/spring-context-2.5.xsd&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;http://www.springframework.org/schema/tx&nbsp;http://www.springframework.org/schema/tx/spring-tx-2.5.xsd"<span class="tag">&gt;</span><span>&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="tag">&lt;</span><span class="tag-name">context:load-time-weaver</span><span>&nbsp;</span><span class="attribute">weaver-class</span><span>=</span><span class="attribute-value">"com.shansun.multidemo.spring.ExtInstrumentationLoadTimeWeaver"</span><span>&nbsp;</span><span class="attribute">aspectj-weaving</span><span>=</span><span class="attribute-value">"autodetect"</span><span>&nbsp;</span><span class="tag">/&gt;</span><span>&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="tag">&lt;</span><span class="tag-name">context:component-scan</span><span>&nbsp;</span><span class="attribute">base-package</span><span>=</span><span class="attribute-value">"com.shansun.multidemo"</span><span class="tag">&gt;</span><span class="tag">&lt;/</span><span class="tag-name">context:component-scan</span><span class="tag">&gt;</span><span>&nbsp;&nbsp;</span></span></li><li><span><span class="tag">&lt;/</span><span class="tag-name">beans</span><span class="tag">&gt;</span><span>&nbsp;&nbsp;</span></span></li></ol></div>
&nbsp;
<p class="MsoNormal" style="text-indent: 0cm;"><span style="font-size: 10.0pt;" lang="EN-US">&nbsp;</span></p>
<p class="MsoNormal"><span>再次运行我们的</span><span lang="EN-US">main</span><span>方法，发现只输出了如下结果，切面没有起作用。</span></p>
<p class="MsoNormal"><em><span style="font-size: 10.0pt;" lang="EN-US">Run</span></em><em></em></p>
<p class="MsoNormal"><em><span style="font-size: 10.0pt;" lang="EN-US">&nbsp;</span></em></p>
<p class="MsoNormal"><span>看到了么，同一份代码、同一份配置，只需要在</span><span lang="EN-US">VM</span><span>启动参数中稍加变化，即可实现同一个应用包在不同环境下可以自由选择使用使用</span><span lang="EN-US">AOP</span><span>功能。文章开头提到的那个需求也就迎刃而解了。</span></p></div><!--EndFragment-->
</body>
</htm</html>